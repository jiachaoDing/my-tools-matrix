<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalDrop Pro - Secure P2P Chat & File Transfer | WebUtilityKit</title>
    <meta name="description" content="LocalDrop Pro: Free, secure peer-to-peer chat and file transfer tool. Real-time messaging, instant file sharing via WebRTC. No accounts, no uploads, 100% browser-based. Privacy-first communication platform.">
    <meta name="keywords" content="P2P chat, file transfer, WebRTC, peer-to-peer, secure messaging, local file sharing, browser-based communication, privacy-first tools, real-time chat, instant file transfer">
    <meta name="author" content="WebUtilityKit">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta property="og:title" content="LocalDrop Pro - Secure P2P Chat & File Transfer">
    <meta property="og:description" content="Free peer-to-peer chat and file transfer tool. Real-time messaging, instant file sharing via WebRTC. No accounts required, 100% browser-based.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://webutilitykit.com/localdrop-pro/">
    <meta property="og:image" content="https://webutilitykit.com/assets/images/localdrop-pro-og.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="LocalDrop Pro - Secure P2P Chat & File Transfer">
    <meta name="twitter:description" content="Free peer-to-peer chat and file transfer tool. Real-time messaging, instant file sharing via WebRTC. No accounts required, 100% browser-based.">
    <link href="../assets/css/styles.css" rel="stylesheet">
    <link rel="canonical" href="https://webutilitykit.com/localdrop-pro/">
    <script src="/tools-config.js"></script>
    <script src="/assets/js/app.js" defer></script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "LocalDrop Pro",
      "description": "Free, secure peer-to-peer chat and file transfer tool powered by WebRTC. Real-time messaging and instant file sharing with no accounts or uploads required.",
      "url": "https://webutilitykit.com/localdrop-pro/",
      "applicationCategory": "CommunicationApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": [
        "Peer-to-peer chat",
        "Secure file transfer",
        "WebRTC powered",
        "No account required",
        "100% browser-based",
        "Privacy-first design"
      ],
      "author": {
        "@type": "Organization",
        "name": "WebUtilityKit"
      }
    }
    </script>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 font-sans min-h-screen flex flex-col transition-colors">

    <!-- Header is automatically injected by components.js -->

    <main class="flex-grow w-full py-12 px-4 sm:px-6">

        <div class="max-w-4xl mx-auto text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight mb-4 text-slate-900 dark:text-white">LocalDrop Pro</h1>
            <p class="text-lg text-slate-600 dark:text-slate-400 max-w-2xl mx-auto">Peer-to-peer chat and file transfer powered by WebRTC. No accounts, no cloud uploads. Connect directly and communicate securely.</p>
            <div class="mt-6 flex items-center justify-center gap-2 text-sm font-medium text-green-700 dark:text-green-400 bg-green-100/50 dark:bg-green-900/20 py-1.5 px-4 rounded-full w-fit mx-auto">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                <span>100% Secure. Processed locally.</span>
            </div>
        </div>

        <div id="tool-wrapper" class="w-full max-w-[1920px] px-6 mx-auto mb-24">

            <!-- App Header -->
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-8">
                <div class="flex items-center gap-3">
                    <div class="w-11 h-11 rounded-2xl bg-sky-600 text-white flex items-center justify-center shadow-lg shadow-sky-500/20">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16h6M12 3a9 9 0 100 18 9 9 0 000-18z"></path></svg>
                    </div>
                    <div>
                        <div class="text-sm uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold">Connection Status</div>
                        <div class="flex items-center gap-2">
                            <span id="status-dot" class="inline-flex w-2.5 h-2.5 rounded-full bg-slate-400"></span>
                            <span id="status-text" class="text-lg font-bold text-slate-900 dark:text-white">Disconnected</span>
                            <span id="status-detail" class="text-xs text-slate-500 dark:text-slate-400"></span>
                        </div>
                    </div>
                </div>

                <div class="flex flex-wrap items-center gap-2">
                    <button id="btn-reset" class="text-xs font-semibold px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 dark:bg-slate-800 dark:hover:bg-slate-700 transition-colors">
                        Reset
                    </button>
                    <button id="btn-disconnect" class="text-xs font-semibold px-3 py-2 rounded-xl bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700/60 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors disabled:opacity-50" disabled>
                        Disconnect
                    </button>
                </div>
            </div>

            <!-- Main Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

                <!-- Left Column -->
                <div class="lg:col-span-4 flex flex-col h-full space-y-6">

                    <!-- Identity & Connection -->
                    <section class="bg-white dark:bg-slate-800/40 rounded-[2rem] p-6 border border-slate-100 dark:border-slate-700/50">
                        <div class="flex items-start justify-between gap-4 mb-4">
                            <div>
                                <h2 class="text-sm font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Identity</h2>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Share your ID to allow others to connect.</p>
                            </div>
                            <span class="text-[10px] uppercase tracking-widest font-black px-2 py-1 rounded-xl bg-emerald-100 text-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-300">WebRTC</span>
                        </div>

                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <div class="flex-1 min-w-0">
                                    <div class="text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1">My ID</div>
                                    <div class="flex items-center gap-2">
                                        <code id="my-id" class="flex-1 min-w-0 truncate text-sm font-mono px-4 py-3 rounded-2xl bg-slate-50 dark:bg-slate-900/40 border border-slate-200/70 dark:border-slate-700/60 text-slate-700 dark:text-slate-200">Initializing…</code>
                                        <button id="btn-copy-id" class="shrink-0 text-xs font-bold px-3 py-3 rounded-2xl bg-sky-600 text-white hover:bg-sky-700 transition-colors disabled:opacity-50" disabled>
                                            Copy
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Share Link (Auto Connect) -->
                            <div id="share-link-wrap" class="hidden">
                                <div class="text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1">Share Link</div>
                                <div class="flex items-center gap-2">
                                    <input id="share-link" type="text" readonly class="w-full px-4 py-3 rounded-2xl bg-slate-50 dark:bg-slate-900/40 border border-slate-200/70 dark:border-slate-700/60 font-mono text-xs text-slate-700 dark:text-slate-200" value="">
                                    <button id="btn-copy-share-link" class="shrink-0 text-xs font-bold px-3 py-3 rounded-2xl bg-white dark:bg-slate-900/30 border border-slate-200 dark:border-slate-700/60 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors disabled:opacity-50" disabled>
                                        Copy
                                    </button>
                                </div>
                                <div class="text-[11px] text-slate-500 dark:text-slate-400 mt-2">
                                    Share this link. When opened, it will auto-fill your ID as the Remote ID and connect.
                                </div>
                            </div>

                            <div>
                                <label for="remote-id" class="text-xs font-semibold text-slate-500 dark:text-slate-400">Remote ID</label>
                                <div class="mt-1 flex items-center gap-2">
                                    <input id="remote-id" type="text" placeholder="Paste remote peer ID…" class="w-full px-4 py-3 rounded-2xl bg-white dark:bg-slate-900/40 border border-slate-200/70 dark:border-slate-700/60 focus:ring-4 focus:ring-sky-500/10 outline-none">
                                    <button id="btn-connect" class="shrink-0 text-xs font-bold px-4 py-3 rounded-2xl bg-sky-600 text-white hover:bg-sky-700 transition-colors disabled:opacity-50">
                                        Connect
                                    </button>
                                </div>
                            </div>

                            <div class="flex items-center justify-between text-xs text-slate-500 dark:text-slate-400">
                                <span>PeerJS cloud ID is random each session.</span>
                                <button id="btn-paste-id" class="font-semibold hover:text-slate-900 dark:hover:text-white transition-colors">Paste</button>
                            </div>
                        </div>
                    </section>

                </div>

                <!-- Right Column -->
                <div class="lg:col-span-8 flex flex-col h-full space-y-6">

                    <!-- Chat -->
                    <section class="bg-white dark:bg-slate-800/40 rounded-[2rem] border border-slate-100 dark:border-slate-700/50 overflow-hidden flex flex-col h-[560px]">
                        <div class="p-5 border-b border-slate-100 dark:border-slate-700/50 flex items-center justify-between gap-4">
                            <div>
                                <h2 class="text-sm font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Chat</h2>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Messages are sent over a WebRTC data channel.</p>
                            </div>
                            <button id="btn-clear-chat" class="text-xs font-semibold px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-slate-900/40 dark:hover:bg-slate-900/60 transition-colors">
                                Clear
                            </button>
                        </div>

                        <div id="chat-log" class="flex-1 overflow-y-auto p-5 space-y-3 custom-scrollbar">
                            <div class="text-sm text-slate-500 dark:text-slate-400 italic" id="chat-empty">Connect to a peer to start chatting.</div>
                        </div>

                        <form id="chat-form" class="p-5 border-t border-slate-100 dark:border-slate-700/50 flex items-center gap-3">
                            <input id="chat-input" type="text" placeholder="Type a message…" class="flex-1 px-4 py-3 rounded-2xl bg-white dark:bg-slate-900/40 border border-slate-200/70 dark:border-slate-700/60 focus:ring-4 focus:ring-sky-500/10 outline-none" autocomplete="off" disabled>
                            <button id="btn-send-chat" type="submit" class="text-xs font-bold px-4 py-3 rounded-2xl bg-sky-600 text-white hover:bg-sky-700 transition-colors disabled:opacity-50" disabled>
                                Send
                            </button>
                        </form>
                    </section>

                    <!-- File Transfer -->
                    <section class="bg-white dark:bg-slate-800/40 rounded-[2rem] p-6 border border-slate-100 dark:border-slate-700/50">
                        <div class="flex items-start justify-between gap-4 mb-4">
                            <div>
                                <h2 class="text-sm font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">File Transfer</h2>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Files are split into chunks for reliable binary transfer.</p>
                            </div>
                            <div class="text-xs text-slate-500 dark:text-slate-400" id="file-conn-hint">Connect first</div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
                            <div class="md:col-span-2">
                                <label class="text-xs font-semibold text-slate-500 dark:text-slate-400">Select file</label>
                                <input id="file-input" type="file" class="mt-1 block w-full text-sm text-slate-600 dark:text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-xs file:font-bold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200 dark:file:bg-slate-900/40 dark:file:text-slate-200 dark:hover:file:bg-slate-900/60" disabled>
                                <div class="text-xs text-slate-500 dark:text-slate-400 mt-2" id="file-selected">No file selected</div>
                            </div>
                            <div class="md:col-span-1">
                                <button id="btn-send-file" class="w-full text-xs font-bold px-4 py-3 rounded-2xl bg-sky-600 text-white hover:bg-sky-700 transition-colors disabled:opacity-50" disabled>
                                    Send File
                                </button>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div class="mt-4 hidden" id="file-progress-wrap">
                            <div class="flex items-center justify-between text-xs text-slate-500 dark:text-slate-400">
                                <span id="file-progress-label">Sending…</span>
                                <span id="file-progress-pct" class="font-semibold">0%</span>
                            </div>
                            <div class="mt-2 h-2 rounded-full bg-slate-200 dark:bg-slate-900/50 overflow-hidden">
                                <div id="file-progress-bar" class="h-full bg-sky-600 w-0 transition-[width]"></div>
                            </div>
                        </div>

                        <!-- Received -->
                        <div class="mt-6">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Received</h3>
                                <button id="btn-clear-received" class="text-xs font-semibold text-slate-500 hover:text-slate-900 dark:text-slate-400 dark:hover:text-white transition-colors hidden">
                                    Clear
                                </button>
                            </div>
                            <div id="received-list" class="mt-3 space-y-2"></div>
                            <div id="received-empty" class="mt-3 text-sm text-slate-500 dark:text-slate-400 italic">No files received yet.</div>
                        </div>
                    </section>

                </div>
            </div>

            <div id="related-tools-section" class="lg:col-span-12 mt-12 hidden"></div>
        </div>

    </main>

    <!-- Toast container -->
    <div id="toast-root" class="fixed bottom-4 right-4 z-[100] w-[92vw] max-w-sm space-y-2 pointer-events-none"></div>

    <!-- Footer is automatically injected by components.js -->
    <script src="../assets/js/components.js"></script>

    <!-- PeerJS (local preferred). If missing, we will auto-load a CDN fallback. -->
    <script src="./peerjs.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ---------- Small helpers ----------
            const $ = (id) => document.getElementById(id);
            const sleep = (ms) => new Promise(r => setTimeout(r, ms));
            const formatBytes = (bytes) => {
                if (!Number.isFinite(bytes)) return '—';
                const units = ['B', 'KB', 'MB', 'GB'];
                let v = bytes, i = 0;
                while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
                return `${v.toFixed(i === 0 ? 0 : 2)} ${units[i]}`;
            };
            const nowTime = () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const safeFilename = (name) => (name || 'download').replace(/[<>:"/\\|?*\x00-\x1F]+/g, '_').slice(0, 180);
            const uuid = () => (crypto?.randomUUID ? crypto.randomUUID() : `f_${Date.now()}_${Math.random().toString(16).slice(2)}`);

            // Generate a 6-character short code (hash-like)
            function generateShortCode() {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Exclude ambiguous chars like I, O, 0, 1
                let res = '';
                // Simple hash based on random + time
                const seed = Date.now().toString(36) + Math.random().toString(36);
                for (let i = 0; i < 6; i++) {
                    const idx = Math.floor(Math.random() * chars.length);
                    res += chars[idx];
                }
                return res;
            }

            // Map short code to a long, unique Peer ID using SHA-256
            async function derivePeerId(shortCode) {
                const prefix = 'wuk-ld-v1-'; // Namespace to avoid collisions with other apps
                const msgUint8 = new TextEncoder().encode(prefix + shortCode.toUpperCase());
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                // Use base64url encoding for URL-safe peer ID (PeerJS requirement)
                const hashBase64 = btoa(String.fromCharCode(...new Uint8Array(hashBuffer)))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=+$/, ''); // Remove padding
                return prefix + hashBase64;
            }

            function toast(message, type = 'info', detail = '') {
                const root = $('toast-root');
                const color = {
                    info: 'bg-slate-900 text-white',
                    success: 'bg-emerald-600 text-white',
                    warn: 'bg-amber-500 text-white',
                    error: 'bg-rose-600 text-white',
                }[type] || 'bg-slate-900 text-white';

                const el = document.createElement('div');
                el.className = `pointer-events-auto rounded-2xl px-4 py-3 shadow-2xl shadow-black/20 border border-white/10 ${color}`;
                el.innerHTML = `
                    <div class="text-sm font-bold">${message}</div>
                    ${detail ? `<div class="text-xs opacity-90 mt-1">${detail}</div>` : ''}
                `;
                root.appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(6px)';
                    el.style.transition = 'all 240ms ease';
                    setTimeout(() => el.remove(), 260);
                }, 2600);
            }

            function setStatus(state, detail = '') {
                const dot = $('status-dot');
                const text = $('status-text');
                const detailEl = $('status-detail');
                const map = {
                    disconnected: { t: 'Disconnected', c: 'bg-slate-400' },
                    connecting: { t: 'Connecting', c: 'bg-amber-400' },
                    connected: { t: 'Connected', c: 'bg-emerald-400' },
                };
                const v = map[state] || map.disconnected;
                dot.className = `inline-flex w-2.5 h-2.5 rounded-full ${v.c}`;
                text.textContent = v.t;
                detailEl.textContent = detail ? `· ${detail}` : '';
            }


            function addChatMessage(side, text, meta = {}) {
                const log = $('chat-log');
                const empty = $('chat-empty');
                if (empty) empty.remove();

                const wrap = document.createElement('div');
                wrap.className = `flex ${side === 'me' ? 'justify-end' : 'justify-start'}`;

                const bubble = document.createElement('div');
                bubble.className = [
                    'max-w-[85%] rounded-2xl px-4 py-3 border',
                    side === 'me'
                        ? 'bg-sky-600 text-white border-sky-500/30'
                        : 'bg-slate-50 dark:bg-slate-900/40 text-slate-800 dark:text-slate-100 border-slate-200/70 dark:border-slate-700/60'
                ].join(' ');

                const header = document.createElement('div');
                header.className = 'text-[10px] font-bold opacity-90 flex items-center justify-between gap-3 mb-1';
                header.innerHTML = `
                    <span>${side === 'me' ? 'You' : 'Peer'}</span>
                    <span class="font-mono opacity-80">${meta.time || nowTime()}</span>
                `;

                const body = document.createElement('div');
                body.className = 'text-sm whitespace-pre-wrap break-words';
                body.textContent = text;

                bubble.appendChild(header);
                bubble.appendChild(body);
                wrap.appendChild(bubble);
                log.appendChild(wrap);
                log.scrollTop = log.scrollHeight;
            }

            // ---------- PeerJS loading fallback ----------
            async function ensurePeerJSLoaded() {
                if (window.Peer) return true;
                toast('PeerJS not detected, loading online version…', 'warn', 'Place peerjs.min.js in localdrop-pro/ directory for offline use');
                try {
                    await new Promise((resolve, reject) => {
                        const s = document.createElement('script');
                        s.src = 'https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js';
                        s.onload = resolve;
                        s.onerror = reject;
                        document.head.appendChild(s);
                    });
                    return !!window.Peer;
                } catch {
                    return false;
                }
            }

            // ---------- State ----------
            let peer = null;
            let conn = null;
            let currentRemoteId = '';


            const incomingTransfers = new Map(); // id -> { meta, receivedBytes, chunks, startedAt }
            let outgoingSending = false;
            let selectedFile = null;

            // ---------- Elements ----------
            const myIdEl = $('my-id');
            const btnCopyId = $('btn-copy-id');
            const shareLinkWrap = $('share-link-wrap');
            const shareLinkEl = $('share-link');
            const btnCopyShareLink = $('btn-copy-share-link');
            const remoteIdEl = $('remote-id');
            const btnConnect = $('btn-connect');
            const btnDisconnect = $('btn-disconnect');
            const btnReset = $('btn-reset');
            const btnPasteId = $('btn-paste-id');

            const chatInput = $('chat-input');
            const btnSendChat = $('btn-send-chat');
            const chatForm = $('chat-form');
            const btnClearChat = $('btn-clear-chat');

            const fileInput = $('file-input');
            const fileSelected = $('file-selected');
            const btnSendFile = $('btn-send-file');
            const fileHint = $('file-conn-hint');
            const fileProgressWrap = $('file-progress-wrap');
            const fileProgressLabel = $('file-progress-label');
            const fileProgressPct = $('file-progress-pct');
            const fileProgressBar = $('file-progress-bar');
            const receivedList = $('received-list');
            const receivedEmpty = $('received-empty');
            const btnClearReceived = $('btn-clear-received');


            // ---------- UI enable/disable ----------
            function setConnectedUI(isConnected) {
                chatInput.disabled = !isConnected;
                btnSendChat.disabled = !isConnected;
                fileInput.disabled = !isConnected;
                btnSendFile.disabled = !isConnected || !selectedFile || outgoingSending;
                btnDisconnect.disabled = !isConnected;
                fileHint.textContent = isConnected ? 'Ready' : 'Connect first';
            }

            function resetFileUI() {
                selectedFile = null;
                fileInput.value = '';
                fileSelected.textContent = 'No file selected';
                outgoingSending = false;
                btnSendFile.disabled = !conn?.open;
                fileProgressWrap.classList.add('hidden');
                fileProgressBar.style.width = '0%';
                fileProgressPct.textContent = '0%';
                fileProgressLabel.textContent = 'Sending…';
            }


            function clearReceivedUI() {
                receivedList.innerHTML = '';
                receivedEmpty.classList.remove('hidden');
                btnClearReceived.classList.add('hidden');
            }

            // ---------- Connection helpers ----------
            function closeConn(reason = '') {
                try { conn?.close(); } catch {}
                conn = null;
                setStatus('disconnected', reason || '');
                setConnectedUI(false);
                btnDisconnect.disabled = true;
            }

            function setActiveRemoteId(id) {
                currentRemoteId = (id || '').trim();
                if (remoteIdEl.value.trim() !== currentRemoteId) remoteIdEl.value = currentRemoteId;
            }

            // ---------- Data messaging ----------
            function sendData(payload) {
                if (!conn || !conn.open) {
                    toast('Not connected to peer', 'error');
                    return false;
                }
                try {
                    conn.send(payload);
                    return true;
                } catch (e) {
                    toast('Send failed', 'error', e?.message || String(e));
                    return false;
                }
            }

            function handleIncomingData(data) {
                // PeerJS delivers: string | object | ArrayBuffer
                if (typeof data === 'string') {
                    // try JSON
                    try { data = JSON.parse(data); } catch { /* ignore */ }
                }

                if (data && typeof data === 'object' && data.t) {
                    if (data.t === 'chat') {
                        addChatMessage('peer', data.text || '', { time: data.time || nowTime() });
                        return;
                    }
                    if (data.t === 'file-meta') {
                        const id = data.id;
                        if (!id) return;
                        incomingTransfers.set(id, {
                            meta: { name: data.name, size: data.size, type: data.type },
                            receivedBytes: 0,
                            chunks: [],
                            startedAt: Date.now(),
                        });
                        toast('Starting file reception', 'info', `${data.name} (${formatBytes(data.size)})`);
                        renderReceivingRow(id, { name: data.name, size: data.size, type: data.type }, 0, 'receiving');
                        return;
                    }
                    if (data.t === 'file-chunk') {
                        const transfer = incomingTransfers.get(data.id);
                        if (!transfer) return;
                        const buf = data.data;
                        if (!(buf instanceof ArrayBuffer)) return;
                        const chunk = new Uint8Array(buf);
                        transfer.chunks.push(chunk);
                        transfer.receivedBytes += chunk.byteLength;
                        const pct = transfer.meta.size ? Math.min(100, Math.floor((transfer.receivedBytes / transfer.meta.size) * 100)) : 0;
                        updateReceivingRow(data.id, pct, `${formatBytes(transfer.receivedBytes)} / ${formatBytes(transfer.meta.size)}`);
                        return;
                    }
                    if (data.t === 'file-end') {
                        const transfer = incomingTransfers.get(data.id);
                        if (!transfer) return;
                        const blob = new Blob(transfer.chunks, { type: transfer.meta.type || 'application/octet-stream' });
                        const url = URL.createObjectURL(blob);
                        const filename = safeFilename(transfer.meta.name);
                        incomingTransfers.delete(data.id);

                        finalizeReceivingRow(data.id, {
                            filename,
                            url,
                            size: blob.size,
                            type: transfer.meta.type || 'application/octet-stream'
                        });
                        toast('File received', 'success', `${filename} (${formatBytes(blob.size)})`);
                        return;
                    }
                }
            }

            function renderReceivingRow(id, meta, pct, state) {
                receivedEmpty.classList.add('hidden');
                btnClearReceived.classList.remove('hidden');

                const row = document.createElement('div');
                row.id = `rx_${id}`;
                row.className = 'rounded-2xl border border-slate-200/70 dark:border-slate-700/60 bg-slate-50 dark:bg-slate-900/30 p-4';
                row.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                            <div class="text-sm font-bold text-slate-900 dark:text-white truncate">${meta.name || 'File'}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                <span class="font-mono">${formatBytes(meta.size)}</span>
                                <span class="mx-2 opacity-50">·</span>
                                <span class="rx_state">${state === 'receiving' ? 'Receiving…' : 'Ready'}</span>
                            </div>
                        </div>
                        <div class="shrink-0 flex items-center gap-2">
                            <a class="rx_download hidden text-xs font-bold px-3 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700 transition-colors" href="#" download>Download</a>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="flex items-center justify-between text-[11px] text-slate-500 dark:text-slate-400">
                            <span class="rx_detail">Waiting…</span>
                            <span class="rx_pct font-semibold">${pct}%</span>
                        </div>
                        <div class="mt-2 h-2 rounded-full bg-slate-200 dark:bg-slate-800/60 overflow-hidden">
                            <div class="rx_bar h-full bg-emerald-500 w-0 transition-[width]"></div>
                        </div>
                    </div>
                `;
                receivedList.prepend(row);
                updateReceivingRow(id, pct, `0 / ${formatBytes(meta.size)}`);
            }

            function updateReceivingRow(id, pct, detail) {
                const row = $(`rx_${id}`);
                if (!row) return;
                row.querySelector('.rx_pct').textContent = `${pct}%`;
                row.querySelector('.rx_bar').style.width = `${pct}%`;
                row.querySelector('.rx_detail').textContent = detail || '';
            }

            function finalizeReceivingRow(id, file) {
                const row = $(`rx_${id}`);
                if (!row) return;
                row.querySelector('.rx_state').textContent = 'Ready';
                row.querySelector('.rx_pct').textContent = '100%';
                row.querySelector('.rx_bar').style.width = '100%';
                row.querySelector('.rx_detail').textContent = `${formatBytes(file.size)} · ${file.type}`;
                const link = row.querySelector('.rx_download');
                link.classList.remove('hidden');
                link.href = file.url;
                link.download = file.filename;
            }

            // ---------- File send ----------
            async function waitForBufferedAmountBelow(thresholdBytes = 4 * 1024 * 1024) {
                // PeerJS internal: conn._dc is RTCPeerConnection DataChannel
                const dc = conn && conn._dc;
                if (!dc) return;
                while (dc.bufferedAmount > thresholdBytes) {
                    await sleep(25);
                }
            }

            async function sendFile(file) {
                if (!file) return;
                if (!conn || !conn.open) {
                    toast('Please connect to a peer first', 'error');
                    return;
                }
                if (outgoingSending) return;
                outgoingSending = true;
                btnSendFile.disabled = true;
                fileProgressWrap.classList.remove('hidden');
                fileProgressLabel.textContent = 'Sending…';
                fileProgressPct.textContent = '0%';
                fileProgressBar.style.width = '0%';

                const id = uuid();
                const meta = { t: 'file-meta', id, name: file.name, size: file.size, type: file.type };
                toast('Starting file transfer', 'info', `${file.name} (${formatBytes(file.size)})`);
                if (!sendData(meta)) {
                    outgoingSending = false;
                    setConnectedUI(!!conn?.open);
                    return;
                }

                const chunkSize = 16 * 1024; // conservative for broad compatibility
                let offset = 0;
                let seq = 0;
                try {
                    while (offset < file.size) {
                        const slice = file.slice(offset, offset + chunkSize);
                        const buf = await slice.arrayBuffer();
                        const ok = sendData({ t: 'file-chunk', id, seq, data: buf });
                        if (!ok) throw new Error('send chunk failed');

                        offset += buf.byteLength;
                        seq++;
                        const pct = Math.min(100, Math.floor((offset / file.size) * 100));
                        fileProgressPct.textContent = `${pct}%`;
                        fileProgressBar.style.width = `${pct}%`;
                        fileProgressLabel.textContent = `Sending… ${formatBytes(offset)} / ${formatBytes(file.size)}`;

                        await waitForBufferedAmountBelow();
                    }

                    sendData({ t: 'file-end', id });
                    fileProgressPct.textContent = '100%';
                    fileProgressBar.style.width = '100%';
                    fileProgressLabel.textContent = 'Sent.';
                    toast('File transfer completed', 'success', file.name);
                } catch (e) {
                    toast('File transfer failed', 'error', e?.message || String(e));
                } finally {
                    outgoingSending = false;
                    setTimeout(() => fileProgressWrap.classList.add('hidden'), 900);
                    resetFileUI();
                    setConnectedUI(!!conn?.open);
                }
            }


            async function copyText(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch {
                    try {
                        const ta = document.createElement('textarea');
                        ta.value = text;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        ta.remove();
                        return true;
                    } catch {
                        return false;
                    }
                }
            }

            function getConnectTargetFromURL() {
                try {
                    const u = new URL(window.location.href);
                    return (
                        u.searchParams.get('connect') ||
                        u.searchParams.get('remote') ||
                        u.searchParams.get('peer') ||
                        ''
                    ).trim();
                } catch {
                    return '';
                }
            }

            function buildShareLinkForMyId(myId) {
                try {
                    const u = new URL(window.location.href);
                    u.searchParams.set('connect', myId);
                    // keep other params (if any), but avoid duplicate aliases
                    u.searchParams.delete('remote');
                    u.searchParams.delete('peer');
                    return u.toString();
                } catch {
                    return '';
                }
            }

            // ---------- Peer lifecycle ----------
            let currentShortCode = ''; // Track the human-readable part

            async function initPeer(retryCount = 0) {
                if (retryCount > 5) {
                    toast('Failed to generate short code after multiple attempts', 'error', 'Please refresh the page to retry');
                    return;
                }

                setStatus('connecting', 'PeerJS');
                myIdEl.textContent = 'Initializing…';
                btnCopyId.disabled = true;
                btnConnect.disabled = true;
                setConnectedUI(false);

                const ok = await ensurePeerJSLoaded();
                if (!ok) {
                    setStatus('disconnected', 'PeerJS unavailable');
                    myIdEl.textContent = 'PeerJS missing';
                    toast('PeerJS loading failed', 'error', 'Place peerjs.min.js in localdrop-pro/ directory or check network connection');
                    btnConnect.disabled = false;
                    return;
                }

                try { peer?.destroy(); } catch {}
                
                currentShortCode = generateShortCode();
                const longId = await derivePeerId(currentShortCode);
                
                peer = new Peer(longId); // Initialize with unique long ID

                peer.on('open', (id) => {
                    // Important: Show the short code to user, not the internal long ID
                    myIdEl.textContent = currentShortCode; 
                    btnCopyId.disabled = false;
                    btnConnect.disabled = false;
                    setStatus('disconnected', 'Ready');
                    toast('Peer ready', 'success', `Short Code: ${currentShortCode}`);

                    // Build & show share link using short code
                    const link = buildShareLinkForMyId(currentShortCode);
                    if (link) {
                        shareLinkEl.value = link;
                        shareLinkWrap.classList.remove('hidden');
                        btnCopyShareLink.disabled = false;
                    }

                    // Auto-connect if opened via shared link
                    const targetShortCode = getConnectTargetFromURL();
                    if (targetShortCode && targetShortCode !== currentShortCode) {
                        remoteIdEl.value = targetShortCode;
                        setActiveRemoteId(targetShortCode);
                        setTimeout(() => connectToRemote(), 120);
                    }
                });

                peer.on('connection', (c) => {
                    // Single active connection: replace existing
                    if (conn && conn.open) {
                        try { conn.close(); } catch {}
                    }
                    conn = c;
                    bindConnection(conn, 'incoming');
                });


                peer.on('error', (e) => {
                    if (e.type === 'unavailable-id') {
                        console.warn('Short code taken, retrying...', retryCount);
                        setTimeout(() => initPeer(retryCount + 1), 100);
                        return;
                    }
                    const msg = e?.type ? `${e.type}` : 'peer error';
                    toast('Peer error', 'error', e?.message || msg);
                    setStatus('disconnected', e?.type || 'Error');
                });

                peer.on('disconnected', () => {
                    toast('Peer disconnected', 'warn', 'May be due to network issues or PeerJS service unavailable');
                    setStatus('disconnected', 'Peer disconnected');
                });
            }

            function bindConnection(c, mode) {
                try { c.binaryType = 'arraybuffer'; } catch {}
                setStatus('connecting', currentRemoteId || 'peer');

                c.on('open', () => {
                    setStatus('connected', currentRemoteId || 'peer');
                    toast('Connected to peer', 'success', currentRemoteId);
                    setConnectedUI(true);
                });

                c.on('data', handleIncomingData);

                c.on('close', () => {
                    toast('Connection closed', 'info');
                    closeConn('');
                    resetFileUI();
                });

                c.on('error', (e) => {
                    toast('Connection error', 'error', e?.message || String(e));
                    closeConn('Error');
                });

                // Make UI usable even while connecting
                setConnectedUI(false);
                btnDisconnect.disabled = false;
                if (mode === 'outgoing') toast('Establishing connection…', 'info', currentRemoteId);
            }

            async function connectToRemote() {
                const ridShort = remoteIdEl.value.trim();
                if (!ridShort) return toast('Please enter Remote ID', 'warn');
                if (!peer) return toast('Peer not ready', 'warn');
                if (ridShort === currentShortCode) return toast('Cannot connect to yourself', 'warn');
                
                setActiveRemoteId(ridShort);

                // Map input short code to the long ID used by PeerJS
                const ridLong = await derivePeerId(ridShort);

                if (conn && conn.open && conn.peer === ridLong) {
                    toast('Already connected to this peer', 'info');
                    return;
                }

                if (conn && conn.open) {
                    try { conn.close(); } catch {}
                }

                try {
                    const c = peer.connect(ridLong, { reliable: true });
                    conn = c;
                    bindConnection(conn, 'outgoing');
                } catch (e) {
                    toast('Connection failed', 'error', e?.message || String(e));
                    setStatus('disconnected', 'Connect failed');
                }
            }

            function disconnect() {
                closeConn('');
                resetFileUI();
                setConnectedUI(false);
                toast('Disconnected', 'info');
            }

            function hardReset() {
                disconnect();
                try { peer?.destroy(); } catch {}
                peer = null;
                incomingTransfers.clear();
                clearReceivedUI();
                $('chat-log').innerHTML = '<div class="text-sm text-slate-500 dark:text-slate-400 italic" id="chat-empty">Connect to a peer to start chatting.</div>';
                initPeer();
            }

            // ---------- Events ----------
            btnCopyId.addEventListener('click', async () => {
                const id = myIdEl.textContent.trim();
                if (!id || id === 'Initializing…') return;
                const ok = await copyText(id);
                toast(ok ? 'My ID copied' : 'Copy failed', ok ? 'success' : 'error');
            });

            btnCopyShareLink.addEventListener('click', async () => {
                const link = (shareLinkEl.value || '').trim();
                if (!link) return;
                const ok = await copyText(link);
                toast(ok ? 'Share link copied' : 'Copy failed', ok ? 'success' : 'error');
            });

            btnPasteId.addEventListener('click', async () => {
                try {
                    const v = await navigator.clipboard.readText();
                    if (v) remoteIdEl.value = v.trim();
                    toast('Remote ID pasted', 'success');
                } catch {
                    toast('Cannot read clipboard', 'warn', 'Please paste Remote ID manually');
                }
            });

            btnConnect.addEventListener('click', connectToRemote);
            remoteIdEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') connectToRemote();
            });

            btnDisconnect.addEventListener('click', disconnect);
            btnReset.addEventListener('click', hardReset);

            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = chatInput.value.trim();
                if (!text) return;
                if (sendData({ t: 'chat', text, time: nowTime() })) {
                    addChatMessage('me', text, { time: nowTime() });
                    chatInput.value = '';
                    chatInput.focus();
                }
            });

            btnClearChat.addEventListener('click', () => {
                $('chat-log').innerHTML = '<div class="text-sm text-slate-500 dark:text-slate-400 italic" id="chat-empty">Chat cleared.</div>';
            });

            fileInput.addEventListener('change', () => {
                selectedFile = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
                fileSelected.textContent = selectedFile ? `${selectedFile.name} · ${formatBytes(selectedFile.size)}${selectedFile.type ? ` · ${selectedFile.type}` : ''}` : 'No file selected';
                btnSendFile.disabled = !conn?.open || !selectedFile || outgoingSending;
            });

            btnSendFile.addEventListener('click', async () => {
                if (!selectedFile) return toast('Please select a file', 'warn');
                await sendFile(selectedFile);
            });

            btnClearReceived.addEventListener('click', () => {
                clearReceivedUI();
                toast('Received files cleared', 'info');
            });


            // ---------- Init ----------
            clearReceivedUI();
            setStatus('connecting', 'Boot');
            setConnectedUI(false);
            initPeer();
        });
    </script>
</body>
</html>

