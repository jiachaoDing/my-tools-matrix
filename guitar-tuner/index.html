<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guitar Tuner - Professional Chromatic Tuner | WebUtilityKit</title>
    <meta name="description" content="Free online guitar tuner with real-time pitch detection. Professional chromatic tuner for guitar, bass, ukulele, and violin. Accurate cents deviation display and auto-string matching.">
    <link href="../assets/css/styles.css" rel="stylesheet">
    <link rel="canonical" href="https://webutilitykit.com/guitar-tuner/">
    <script src="/tools-config.js"></script>
    <script src="/assets/js/app.js" defer></script>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 font-sans min-h-screen flex flex-col transition-colors">
    
    <!-- Header is automatically injected by components.js -->

    <main class="flex-grow w-full py-12 px-4 sm:px-6">
        
        <div class="max-w-4xl mx-auto text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight mb-4 text-slate-900 dark:text-white">Guitar Tuner</h1>
            <p class="text-lg text-slate-600 dark:text-slate-400 max-w-2xl mx-auto">Professional chromatic tuner with real-time pitch detection for guitar, bass, ukulele, and violin</p>
            <div class="mt-6 flex items-center justify-center gap-2 text-sm font-medium text-green-700 dark:text-green-400 bg-green-100/50 dark:bg-green-900/20 py-1.5 px-4 rounded-full w-fit mx-auto">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                <span>100% Secure. Processed locally.</span>
            </div>
        </div>

        <div id="tool-wrapper" class="w-full max-w-[1920px] px-6 mx-auto mb-24">
            
            <!-- Instrument Selection Screen -->
            <div id="instrument-selection" class="max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-8 text-center">Choose Your Instrument</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Guitar -->
                    <button onclick="selectInstrument('guitar')" class="instrument-card group relative p-8 rounded-3xl bg-gradient-to-br from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 transition-all hover:scale-105 hover:shadow-2xl cursor-pointer">
                        <div class="text-white text-center">
                            <div class="text-6xl mb-4">üé∏</div>
                            <h3 class="text-2xl font-bold mb-2">Guitar</h3>
                            <p class="text-sm opacity-90">Standard (E-A-D-G-B-E)</p>
                        </div>
                    </button>
                    
                    <!-- Bass -->
                    <button onclick="selectInstrument('bass')" class="instrument-card group relative p-8 rounded-3xl bg-gradient-to-br from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 transition-all hover:scale-105 hover:shadow-2xl cursor-pointer">
                        <div class="text-white text-center">
                            <div class="text-6xl mb-4">üé∏</div>
                            <h3 class="text-2xl font-bold mb-2">Bass</h3>
                            <p class="text-sm opacity-90">4-String (E-A-D-G)</p>
                        </div>
                    </button>
                    
                    <!-- Ukulele -->
                    <button onclick="selectInstrument('ukulele')" class="instrument-card group relative p-8 rounded-3xl bg-gradient-to-br from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 transition-all hover:scale-105 hover:shadow-2xl cursor-pointer">
                        <div class="text-white text-center">
                            <div class="text-6xl mb-4">üéª</div>
                            <h3 class="text-2xl font-bold mb-2">Ukulele</h3>
                            <p class="text-sm opacity-90">Standard (G-C-E-A)</p>
                        </div>
                    </button>
                    
                    <!-- Violin -->
                    <button onclick="selectInstrument('violin')" class="instrument-card group relative p-8 rounded-3xl bg-gradient-to-br from-rose-500 to-pink-600 hover:from-rose-600 hover:to-pink-700 transition-all hover:scale-105 hover:shadow-2xl cursor-pointer">
                        <div class="text-white text-center">
                            <div class="text-6xl mb-4">üéª</div>
                            <h3 class="text-2xl font-bold mb-2">Violin</h3>
                            <p class="text-sm opacity-90">Standard (G-D-A-E)</p>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Tuner Interface (Hidden by default) -->
            <div id="tuner-interface" class="hidden max-w-3xl mx-auto">
                
                <!-- Back Button -->
                <button onclick="backToSelection()" class="mb-6 flex items-center gap-2 text-slate-600 dark:text-slate-400 hover:text-sky-600 dark:hover:text-sky-400 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    <span class="font-medium">Back to Instruments</span>
                </button>

                <!-- Current Instrument Display -->
                <div class="text-center mb-8">
                    <h2 id="current-instrument" class="text-3xl font-bold text-slate-900 dark:text-white mb-2"></h2>
                    <p class="text-slate-600 dark:text-slate-400">Play a string to start tuning</p>
                    <div id="calibration-counter" class="mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-800 text-sm font-medium text-slate-700 dark:text-slate-300">
                        <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span id="calibrated-count">0 / 0</span> calibrated
                    </div>
                </div>

                <!-- Microphone Status -->
                <div id="mic-status" class="mb-8 p-4 rounded-2xl bg-slate-100 dark:bg-slate-800 text-center">
                    <p class="text-slate-600 dark:text-slate-400">Requesting microphone access...</p>
                </div>

                <!-- String Display -->
                <div id="strings-display" class="mb-8 flex justify-center gap-3 flex-wrap">
                    <!-- Strings will be dynamically generated -->
                </div>

                <!-- Main Tuner Display -->
                <div class="bg-white dark:bg-slate-800 rounded-3xl p-12 shadow-2xl mb-8">
                    
                    <!-- Current Note -->
                    <div class="text-center mb-8">
                        <div id="detected-note" class="text-8xl font-black text-slate-900 dark:text-white mb-2 transition-all">
                            --
                        </div>
                        <div id="target-frequency" class="text-lg text-slate-500 dark:text-slate-400">
                            -- Hz
                        </div>
                    </div>

                    <!-- Cents Deviation Display -->
                    <div class="relative h-32 mb-8">
                        <!-- Center Line -->
                        <div class="absolute left-1/2 top-0 bottom-0 w-1 bg-slate-300 dark:bg-slate-600 -translate-x-1/2"></div>
                        
                        <!-- Deviation Indicator -->
                        <div id="deviation-indicator" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-20 rounded-full bg-slate-300 dark:bg-slate-600 transition-all duration-100 flex items-center justify-center">
                            <span id="cents-value" class="text-2xl font-bold text-slate-900 dark:text-white">0</span>
                        </div>
                        
                        <!-- Scale Markers -->
                        <div class="absolute top-1/2 left-0 right-0 -translate-y-1/2 flex justify-between px-4">
                            <span class="text-sm text-slate-400">-50</span>
                            <span class="text-sm text-slate-400">0</span>
                            <span class="text-sm text-slate-400">+50</span>
                        </div>
                    </div>

                    <!-- Tuning Status -->
                    <div id="tuning-status" class="text-center">
                        <div class="text-lg font-medium text-slate-600 dark:text-slate-400">
                            <span id="status-text">Play a string</span>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex justify-center gap-4">
                    <button id="toggle-tuner" onclick="toggleTuner()" class="px-8 py-3 bg-sky-600 hover:bg-sky-700 text-white font-semibold rounded-xl transition-colors shadow-lg">
                        Stop Tuner
                    </button>
                    <button onclick="resetCalibration()" class="px-8 py-3 bg-slate-600 hover:bg-slate-700 text-white font-semibold rounded-xl transition-colors shadow-lg">
                        Reset All
                    </button>
                </div>
            </div>
            
            <div id="related-tools-section" class="lg:col-span-12 mt-12 hidden"></div>           
        </div>

        <!-- Editorial Section -->
        <div class="max-w-5xl mx-auto border-t border-slate-200 dark:border-slate-800 pt-24 pb-24">
            <article class="space-y-24">
                
                <!-- How to Use -->
                <section>
                    <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-12 text-center italic tracking-tight">How to use Guitar Tuner</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- Step 1 -->
                        <div class="relative p-8 rounded-[2.5rem] bg-white dark:bg-slate-800/40 border border-slate-100 dark:border-slate-700/50 hover:shadow-2xl hover:shadow-sky-500/5 transition-all group text-center">
                            <div class="w-16 h-16 bg-sky-600 text-white rounded-2xl flex items-center justify-center font-bold text-2xl shadow-lg shadow-sky-500/30 mx-auto mb-6 group-hover:scale-110 transition-transform">1</div>
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-3 text-pretty">Select Instrument</h3>
                            <p class="text-slate-600 dark:text-slate-400 leading-relaxed text-sm text-pretty">Choose your instrument from guitar, bass, ukulele, or violin. Each has pre-configured standard tuning.</p>
                        </div>
                        <!-- Step 2 -->
                        <div class="relative p-8 rounded-[2.5rem] bg-white dark:bg-slate-800/40 border border-slate-100 dark:border-slate-700/50 hover:shadow-2xl hover:shadow-sky-500/5 transition-all group text-center">
                            <div class="w-16 h-16 bg-sky-600 text-white rounded-2xl flex items-center justify-center font-bold text-2xl shadow-lg shadow-sky-500/30 mx-auto mb-6 group-hover:scale-110 transition-transform">2</div>
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-3 text-pretty">Allow Microphone</h3>
                            <p class="text-slate-600 dark:text-slate-400 leading-relaxed text-sm text-pretty">Grant microphone access when prompted. The tuner uses real-time audio analysis to detect pitch.</p>
                        </div>
                        <!-- Step 3 -->
                        <div class="relative p-8 rounded-[2.5rem] bg-white dark:bg-slate-800/40 border border-slate-100 dark:border-slate-700/50 hover:shadow-2xl hover:shadow-sky-500/5 transition-all group text-center">
                            <div class="w-16 h-16 bg-sky-600 text-white rounded-2xl flex items-center justify-center font-bold text-2xl shadow-lg shadow-sky-500/30 mx-auto mb-6 group-hover:scale-110 transition-transform">3</div>
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-3 text-pretty">Tune Your String</h3>
                            <p class="text-slate-600 dark:text-slate-400 leading-relaxed text-sm text-pretty">Play a string and watch the cents deviation. Adjust until the indicator turns green (¬±10 cents).</p>
                        </div>
                    </div>
                </section>

                <!-- Feature Grid -->
                <section>
                    <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-12 text-center">Key Features</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="flex gap-6 p-10 rounded-[2.5rem] bg-slate-50 dark:bg-slate-800/20 border-2 border-transparent hover:border-sky-500/10 transition-all group">
                            <div class="flex-shrink-0 w-14 h-14 bg-sky-100 dark:bg-sky-900/30 text-sky-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path></svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Real-Time Detection</h3>
                                <p class="text-slate-600 dark:text-slate-400 leading-relaxed text-sm">Advanced WebAudio API with autocorrelation algorithm for instant, accurate pitch detection.</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-6 p-10 rounded-[2.5rem] bg-slate-50 dark:bg-slate-800/20 border-2 border-transparent hover:border-sky-500/10 transition-all group">
                            <div class="flex-shrink-0 w-14 h-14 bg-green-100 dark:bg-green-900/30 text-green-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Cents Precision</h3>
                                <p class="text-slate-600 dark:text-slate-400 leading-relaxed text-sm">Shows exact deviation in cents (+/-) with visual feedback when you hit the perfect pitch.</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-6 p-10 rounded-[2.5rem] bg-slate-50 dark:bg-slate-800/20 border-2 border-transparent hover:border-sky-500/10 transition-all group">
                            <div class="flex-shrink-0 w-14 h-14 bg-purple-100 dark:bg-purple-900/30 text-purple-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Auto String Matching</h3>
                                <p class="text-slate-600 dark:text-slate-400 leading-relaxed text-sm">Automatically identifies and highlights the closest string to the detected pitch.</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-6 p-10 rounded-[2.5rem] bg-slate-50 dark:bg-slate-800/20 border-2 border-transparent hover:border-sky-500/10 transition-all group">
                            <div class="flex-shrink-0 w-14 h-14 bg-amber-100 dark:bg-amber-900/30 text-amber-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Multiple Instruments</h3>
                                <p class="text-slate-600 dark:text-slate-400 leading-relaxed text-sm">Supports guitar, bass, ukulele, and violin with standard tuning configurations.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- FAQ -->
                <section>
                    <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-12 text-center italic">Frequently Asked Questions</h2>
                    <div class="max-w-3xl mx-auto space-y-4">
                        <details class="group bg-slate-50 dark:bg-slate-800/20 rounded-[2rem] p-8 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800/40 transition-all border border-transparent hover:border-sky-500/10">
                            <summary class="flex justify-between items-center font-bold text-slate-900 dark:text-white list-none">
                                <span class="text-xl">Is this tuner accurate?</span>
                                <span class="transition-transform group-open:rotate-180 bg-white dark:bg-slate-700 p-2 rounded-xl shadow-sm">
                                    <svg fill="none" height="20" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" width="20"><path d="M6 9l6 6 6-6"></path></svg>
                                </span>
                            </summary>
                            <div class="text-slate-600 dark:text-slate-400 mt-6 leading-relaxed text-lg text-pretty">
                                Yes! This tuner uses professional-grade autocorrelation pitch detection with cents precision. It's accurate within ¬±1 cent for clear signals.
                            </div>
                        </details>
                        
                        <details class="group bg-slate-50 dark:bg-slate-800/20 rounded-[2rem] p-8 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800/40 transition-all border border-transparent hover:border-sky-500/10">
                            <summary class="flex justify-between items-center font-bold text-slate-900 dark:text-white list-none">
                                <span class="text-xl">What does "cents" mean?</span>
                                <span class="transition-transform group-open:rotate-180 bg-white dark:bg-slate-700 p-2 rounded-xl shadow-sm">
                                    <svg fill="none" height="20" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" width="20"><path d="M6 9l6 6 6-6"></path></svg>
                                </span>
                            </summary>
                            <div class="text-slate-600 dark:text-slate-400 mt-6 leading-relaxed text-lg text-pretty">
                                A cent is a unit of musical pitch. 100 cents = one semitone. The tuner shows how many cents sharp (+) or flat (-) you are from the target note. Within ¬±10 cents is considered in tune.
                            </div>
                        </details>
                        
                        <details class="group bg-slate-50 dark:bg-slate-800/20 rounded-[2rem] p-8 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800/40 transition-all border border-transparent hover:border-sky-500/10">
                            <summary class="flex justify-between items-center font-bold text-slate-900 dark:text-white list-none">
                                <span class="text-xl">Does it work on mobile devices?</span>
                                <span class="transition-transform group-open:rotate-180 bg-white dark:bg-slate-700 p-2 rounded-xl shadow-sm">
                                    <svg fill="none" height="20" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" width="20"><path d="M6 9l6 6 6-6"></path></svg>
                                </span>
                            </summary>
                            <div class="text-slate-600 dark:text-slate-400 mt-6 leading-relaxed text-lg text-pretty">
                                Absolutely! This tuner works on any device with a microphone and a modern browser. Perfect for tuning on the go.
                            </div>
                        </details>
                        
                        <details class="group bg-slate-50 dark:bg-slate-800/20 rounded-[2rem] p-8 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800/40 transition-all border border-transparent hover:border-sky-500/10">
                            <summary class="flex justify-between items-center font-bold text-slate-900 dark:text-white list-none">
                                <span class="text-xl">Is my audio data private?</span>
                                <span class="transition-transform group-open:rotate-180 bg-white dark:bg-slate-700 p-2 rounded-xl shadow-sm">
                                    <svg fill="none" height="20" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" width="20"><path d="M6 9l6 6 6-6"></path></svg>
                                </span>
                            </summary>
                            <div class="text-slate-600 dark:text-slate-400 mt-6 leading-relaxed text-lg text-pretty">
                                Yes, 100% private. All audio processing happens directly in your browser. No audio data is uploaded to any server.
                            </div>
                        </details>

                        <details class="group bg-slate-50 dark:bg-slate-800/20 rounded-[2rem] p-8 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800/40 transition-all border border-transparent hover:border-sky-500/10">
                            <summary class="flex justify-between items-center font-bold text-slate-900 dark:text-white list-none">
                                <span class="text-xl">Can I use this for chromatic tuning?</span>
                                <span class="transition-transform group-open:rotate-180 bg-white dark:bg-slate-700 p-2 rounded-xl shadow-sm">
                                    <svg fill="none" height="20" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" width="20"><path d="M6 9l6 6 6-6"></path></svg>
                                </span>
                            </summary>
                            <div class="text-slate-600 dark:text-slate-400 mt-6 leading-relaxed text-lg text-pretty">
                                Yes! The tuner detects any note in the chromatic scale and automatically matches it to the closest string for your selected instrument.
                            </div>
                        </details>
                    </div>
                </section>

            </article>
        </div>
      
    </main>

    <!-- Footer is automatically injected by components.js -->

    <!-- Áªü‰∏ÄÁªÑ‰ª∂ÁÆ°ÁêÜ -->
    <script src="../assets/js/components.js"></script>

    <script>
        // === Instrument Configurations ===
        const INSTRUMENTS = {
            guitar: {
                name: 'Guitar',
                strings: [
                    { note: 'E', octave: 2, frequency: 82.41 },   // E2
                    { note: 'A', octave: 2, frequency: 110.00 },  // A2
                    { note: 'D', octave: 3, frequency: 146.83 },  // D3
                    { note: 'G', octave: 3, frequency: 196.00 },  // G3
                    { note: 'B', octave: 3, frequency: 246.94 },  // B3
                    { note: 'E', octave: 4, frequency: 329.63 }   // E4
                ]
            },
            bass: {
                name: 'Bass Guitar',
                strings: [
                    { note: 'E', octave: 1, frequency: 41.20 },   // E1
                    { note: 'A', octave: 1, frequency: 55.00 },   // A1
                    { note: 'D', octave: 2, frequency: 73.42 },   // D2
                    { note: 'G', octave: 2, frequency: 98.00 }    // G2
                ]
            },
            ukulele: {
                name: 'Ukulele',
                strings: [
                    { note: 'G', octave: 4, frequency: 392.00 },  // G4
                    { note: 'C', octave: 4, frequency: 261.63 },  // C4
                    { note: 'E', octave: 4, frequency: 329.63 },  // E4
                    { note: 'A', octave: 4, frequency: 440.00 }   // A4
                ]
            },
            violin: {
                name: 'Violin',
                strings: [
                    { note: 'G', octave: 3, frequency: 196.00 },  // G3
                    { note: 'D', octave: 4, frequency: 293.66 },  // D4
                    { note: 'A', octave: 4, frequency: 440.00 },  // A4
                    { note: 'E', octave: 5, frequency: 659.25 }   // E5
                ]
            }
        };

        // === Global Variables ===
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let scriptProcessor = null;
        let currentInstrument = null;
        let isListening = false;
        let animationFrameId = null;
        
        // Calibration tracking
        let stringCalibrationTimers = {}; // Track time in tune for each string
        let calibratedStrings = new Set(); // Set of calibrated string indices
        const CALIBRATION_DURATION = 2000; // 2 seconds in tune = calibrated
        let lastDetectedString = null;
        let inTuneStartTime = null;
        
        // Stability tracking
        let recentCents = []; // Store recent cents values for stability check
        const STABILITY_WINDOW = 20; // Number of recent samples to check
        const MAX_CENTS_STDDEV = 4; // Maximum standard deviation in cents (stability threshold)
        const MIN_STABLE_SAMPLES = 15; // Minimum consecutive stable samples required
        let stableSampleCount = 0; // Counter for consecutive stable samples

        // === Calculate Standard Deviation ===
        function calculateStdDev(values) {
            if (values.length === 0) return 0;
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            return Math.sqrt(variance);
        }
        
        // === Check Pitch Stability ===
        function isPitchStable(cents) {
            // Add current cents to recent history
            recentCents.push(cents);
            if (recentCents.length > STABILITY_WINDOW) {
                recentCents.shift(); // Keep only recent samples
            }
            
            // Need enough samples
            if (recentCents.length < MIN_STABLE_SAMPLES) {
                return false;
            }
            
            // Calculate stability (standard deviation)
            const stdDev = calculateStdDev(recentCents);
            
            // Check if pitch is stable enough
            return stdDev <= MAX_CENTS_STDDEV;
        }
        
        // === Reset Stability Tracking ===
        function resetStabilityTracking() {
            recentCents = [];
            stableSampleCount = 0;
        }

        // === Play Success Sound ===
        function playSuccessSound() {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Play two notes (C5 -> E5) for a pleasant "ding"
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // === Pitch Detection using Autocorrelation ===
        function autoCorrelate(buffer, sampleRate) {
            const SIZE = buffer.length;
            const MAX_SAMPLES = Math.floor(SIZE / 2);
            let best_offset = -1;
            let best_correlation = 0;
            let rms = 0;
            
            // Calculate RMS (Root Mean Square) for noise threshold
            for (let i = 0; i < SIZE; i++) {
                const val = buffer[i];
                rms += val * val;
            }
            rms = Math.sqrt(rms / SIZE);
            
            // Not enough signal - increased threshold for clearer signal
            if (rms < 0.03) return -1;
            
            // Find the best correlation
            let lastCorrelation = 1;
            for (let offset = 1; offset < MAX_SAMPLES; offset++) {
                let correlation = 0;
                
                for (let i = 0; i < MAX_SAMPLES; i++) {
                    correlation += Math.abs(buffer[i] - buffer[i + offset]);
                }
                
                correlation = 1 - (correlation / MAX_SAMPLES);
                
                if (correlation > 0.9 && correlation > lastCorrelation) {
                    const foundGoodCorrelation = (correlation > best_correlation);
                    if (foundGoodCorrelation) {
                        best_correlation = correlation;
                        best_offset = offset;
                    }
                }
                
                lastCorrelation = correlation;
            }
            
            if (best_correlation > 0.01) {
                return sampleRate / best_offset;
            }
            return -1;
        }

        // === Frequency to Note Conversion ===
        function frequencyToNote(frequency) {
            const noteStrings = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const A4 = 440;
            const C0 = A4 * Math.pow(2, -4.75);
            
            if (frequency < 20) return null;
            
            const halfSteps = 12 * Math.log2(frequency / C0);
            const noteNum = Math.round(halfSteps);
            const octave = Math.floor(noteNum / 12);
            const noteName = noteStrings[noteNum % 12];
            const cents = Math.floor((halfSteps - noteNum) * 100);
            
            return {
                note: noteName,
                octave: octave,
                frequency: frequency,
                cents: cents
            };
        }

        // === Find Closest String ===
        function findClosestString(frequency) {
            if (!currentInstrument || !frequency) return null;
            
            const strings = INSTRUMENTS[currentInstrument].strings;
            let closest = null;
            let minDiff = Infinity;
            
            strings.forEach((string, index) => {
                const diff = Math.abs(frequency - string.frequency);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = { ...string, index: index };
                }
            });
            
            // Calculate cents deviation from the closest string
            if (closest) {
                const cents = Math.round(1200 * Math.log2(frequency / closest.frequency));
                closest.cents = cents;
                closest.inTune = Math.abs(cents) <= 10; // Within ¬±10 cents is considered in tune
            }
            
            return closest;
        }

        // === Update UI ===
        function updateTunerUI(frequency) {
            const noteInfo = frequencyToNote(frequency);
            const closestString = findClosestString(frequency);
            
            if (!noteInfo || !closestString) {
                document.getElementById('detected-note').textContent = '--';
                document.getElementById('target-frequency').textContent = '-- Hz';
                document.getElementById('cents-value').textContent = '0';
                document.getElementById('status-text').textContent = 'Play a string';
                resetDeviationIndicator();
                // Reset timer if no signal
                inTuneStartTime = null;
                lastDetectedString = null;
                resetStabilityTracking();
                return;
            }
            
            // Update note display
            document.getElementById('detected-note').textContent = `${noteInfo.note}${noteInfo.octave}`;
            document.getElementById('target-frequency').textContent = `${frequency.toFixed(1)} Hz`;
            
            // Update cents display
            const cents = closestString.cents;
            document.getElementById('cents-value').textContent = cents > 0 ? `+${cents}` : cents;
            
            // Update deviation indicator position and color
            const indicator = document.getElementById('deviation-indicator');
            const maxOffset = 200; // Maximum pixels to move (for ¬±50 cents)
            const offset = Math.max(-maxOffset, Math.min(maxOffset, (cents / 50) * maxOffset));
            
            indicator.style.transform = `translate(calc(-50% + ${offset}px), -50%)`;
            
            // Check if already calibrated
            const isCalibrated = calibratedStrings.has(closestString.index);
            
            if (closestString.inTune) {
                // Check stability
                const isStable = isPitchStable(cents);
                
                if (isStable) {
                    stableSampleCount++;
                    indicator.className = 'absolute top-1/2 left-1/2 w-20 h-20 rounded-full transition-all duration-100 flex items-center justify-center bg-green-500 shadow-lg shadow-green-500/50';
                } else {
                    stableSampleCount = 0;
                    // In tune but not stable - show yellow indicator
                    indicator.className = 'absolute top-1/2 left-1/2 w-20 h-20 rounded-full transition-all duration-100 flex items-center justify-center bg-yellow-500 shadow-lg shadow-yellow-500/50';
                }
                
                // Calibration timing logic
                if (!isCalibrated) {
                    if (lastDetectedString !== closestString.index) {
                        // Different string detected, reset everything
                        inTuneStartTime = Date.now();
                        lastDetectedString = closestString.index;
                        resetStabilityTracking();
                        stableSampleCount = 0;
                    } else if (inTuneStartTime && isStable && stableSampleCount >= MIN_STABLE_SAMPLES) {
                        // Same string, stable enough, check elapsed time
                        const elapsedTime = Date.now() - inTuneStartTime;
                        const progress = Math.min(100, (elapsedTime / CALIBRATION_DURATION) * 100);
                        
                        if (elapsedTime >= CALIBRATION_DURATION) {
                            // Calibrated!
                            calibratedStrings.add(closestString.index);
                            playSuccessSound();
                            document.getElementById('status-text').textContent = 'üéâ String Calibrated!';
                            updateCalibrationProgress(closestString.index, 100);
                            checkAllStringsCalibrated();
                            resetStabilityTracking();
                        } else {
                            // Show progress
                            document.getElementById('status-text').textContent = `‚è± Hold steady... ${Math.ceil((CALIBRATION_DURATION - elapsedTime) / 100) / 10}s`;
                            updateCalibrationProgress(closestString.index, progress);
                        }
                        document.getElementById('status-text').className = 'text-lg font-bold text-green-600 dark:text-green-400';
                    } else if (!isStable || stableSampleCount < MIN_STABLE_SAMPLES) {
                        // In tune but not stable enough yet
                        const stdDev = calculateStdDev(recentCents);
                        document.getElementById('status-text').textContent = `‚ö° Stabilizing... (${stableSampleCount}/${MIN_STABLE_SAMPLES})`;
                        document.getElementById('status-text').className = 'text-lg font-medium text-yellow-600 dark:text-yellow-400';
                        updateCalibrationProgress(closestString.index, 0);
                        // Reset timer until stable
                        inTuneStartTime = Date.now();
                    }
                } else {
                    document.getElementById('status-text').textContent = '‚úì Calibrated';
                    document.getElementById('status-text').className = 'text-lg font-bold text-green-600 dark:text-green-400';
                }
            } else {
                // Not in tune, reset everything
                inTuneStartTime = null;
                lastDetectedString = null;
                resetStabilityTracking();
                stableSampleCount = 0;
                updateCalibrationProgress(closestString.index, 0);
                
                if (cents < 0) {
                    indicator.className = 'absolute top-1/2 left-1/2 w-20 h-20 rounded-full transition-all duration-100 flex items-center justify-center bg-blue-500 shadow-lg shadow-blue-500/50';
                    document.getElementById('status-text').textContent = '‚Üì Too Flat';
                    document.getElementById('status-text').className = 'text-lg font-medium text-blue-600 dark:text-blue-400';
                } else {
                    indicator.className = 'absolute top-1/2 left-1/2 w-20 h-20 rounded-full transition-all duration-100 flex items-center justify-center bg-orange-500 shadow-lg shadow-orange-500/50';
                    document.getElementById('status-text').textContent = '‚Üë Too Sharp';
                    document.getElementById('status-text').className = 'text-lg font-medium text-orange-600 dark:text-orange-400';
                }
            }
            
            // Highlight the closest string
            highlightString(closestString.index, closestString.inTune, isCalibrated);
        }

        function resetDeviationIndicator() {
            const indicator = document.getElementById('deviation-indicator');
            indicator.style.transform = 'translate(-50%, -50%)';
            indicator.className = 'absolute top-1/2 left-1/2 w-20 h-20 rounded-full bg-slate-300 dark:bg-slate-600 transition-all duration-100 flex items-center justify-center';
        }

        function highlightString(index, inTune, isCalibrated) {
            const stringElements = document.querySelectorAll('.string-badge');
            stringElements.forEach((el, i) => {
                const stringIsCalibrated = calibratedStrings.has(i);
                
                if (stringIsCalibrated) {
                    // Permanently green for calibrated strings
                    el.className = 'string-badge px-4 py-2 rounded-xl font-bold text-sm transition-all bg-green-500 text-white shadow-lg shadow-green-500/50';
                } else if (i === index) {
                    if (inTune) {
                        el.className = 'string-badge px-4 py-2 rounded-xl font-bold text-sm transition-all bg-green-500 text-white shadow-lg shadow-green-500/50 scale-110';
                    } else {
                        el.className = 'string-badge px-4 py-2 rounded-xl font-bold text-sm transition-all bg-sky-500 text-white shadow-lg shadow-sky-500/50 scale-105';
                    }
                } else {
                    el.className = 'string-badge px-4 py-2 rounded-xl font-bold text-sm transition-all bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300';
                }
            });
        }
        
        function updateCalibrationProgress(index, progress) {
            const progressBar = document.getElementById(`progress-${index}`);
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
        }
        
        function updateCalibrationCounter() {
            const totalStrings = INSTRUMENTS[currentInstrument].strings.length;
            const calibratedCount = calibratedStrings.size;
            document.getElementById('calibrated-count').textContent = `${calibratedCount} / ${totalStrings}`;
        }
        
        function checkAllStringsCalibrated() {
            const totalStrings = INSTRUMENTS[currentInstrument].strings.length;
            updateCalibrationCounter();
            
            if (calibratedStrings.size === totalStrings) {
                document.getElementById('status-text').textContent = 'üéä All Strings Calibrated!';
                document.getElementById('status-text').className = 'text-lg font-black text-green-600 dark:text-green-400';
                // Play celebratory sound
                setTimeout(() => playSuccessSound(), 100);
                setTimeout(() => playSuccessSound(), 300);
            }
        }

        // === Audio Processing ===
        function startListening() {
            if (!audioContext) return;
            
            scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);
            const buffer = new Float32Array(2048);
            
            scriptProcessor.onaudioprocess = function(event) {
                const input = event.inputBuffer.getChannelData(0);
                buffer.set(input);
                
                const frequency = autoCorrelate(buffer, audioContext.sampleRate);
                
                if (frequency > 0) {
                    updateTunerUI(frequency);
                }
            };
            
            microphone.connect(scriptProcessor);
            scriptProcessor.connect(audioContext.destination);
            isListening = true;
        }

        function stopListening() {
            if (scriptProcessor) {
                microphone.disconnect(scriptProcessor);
                scriptProcessor.disconnect();
                scriptProcessor = null;
            }
            isListening = false;
        }

        // === Initialize Audio ===
        async function initAudio() {
            try {
                document.getElementById('mic-status').innerHTML = '<p class="text-slate-600 dark:text-slate-400">Requesting microphone access...</p>';
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                document.getElementById('mic-status').innerHTML = `
                    <div class="flex items-center justify-center gap-2 text-green-600 dark:text-green-400">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span class="font-medium">Microphone active - Ready to tune</span>
                    </div>
                `;
                
                startListening();
            } catch (error) {
                console.error('Microphone access denied:', error);
                document.getElementById('mic-status').innerHTML = `
                    <div class="text-red-600 dark:text-red-400">
                        <p class="font-medium mb-2">‚ùå Microphone access denied</p>
                        <p class="text-sm">Please allow microphone access to use the tuner.</p>
                    </div>
                `;
            }
        }

        // === Render Strings Display ===
        function renderStrings() {
            const stringsDisplay = document.getElementById('strings-display');
            const strings = INSTRUMENTS[currentInstrument].strings;
            
            stringsDisplay.innerHTML = strings.map((string, index) => `
                <div class="relative">
                    <div class="string-badge px-4 py-2 rounded-xl font-bold text-sm transition-all bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300">
                        ${string.note}${string.octave}
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-slate-300 dark:bg-slate-600 rounded-b-xl overflow-hidden">
                        <div id="progress-${index}" class="h-full bg-green-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            `).join('');
        }

        // === Reset Calibration ===
        window.resetCalibration = function() {
            calibratedStrings.clear();
            inTuneStartTime = null;
            lastDetectedString = null;
            resetStabilityTracking();
            stableSampleCount = 0;
            
            // Reset all progress bars
            const strings = INSTRUMENTS[currentInstrument].strings;
            strings.forEach((_, index) => {
                updateCalibrationProgress(index, 0);
            });
            
            // Reset string badges
            const stringElements = document.querySelectorAll('.string-badge');
            stringElements.forEach((el) => {
                el.className = 'string-badge px-4 py-2 rounded-xl font-bold text-sm transition-all bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300';
            });
            
            document.getElementById('status-text').textContent = 'Play a string';
            document.getElementById('status-text').className = 'text-lg font-medium text-slate-600 dark:text-slate-400';
            
            updateCalibrationCounter();
        };
        
        // === Select Instrument ===
        window.selectInstrument = function(instrument) {
            currentInstrument = instrument;
            calibratedStrings.clear();
            inTuneStartTime = null;
            lastDetectedString = null;
            resetStabilityTracking();
            stableSampleCount = 0;
            
            document.getElementById('instrument-selection').classList.add('hidden');
            document.getElementById('tuner-interface').classList.remove('hidden');
            document.getElementById('current-instrument').textContent = INSTRUMENTS[instrument].name;
            
            renderStrings();
            
            // Initialize calibration counter
            const totalStrings = INSTRUMENTS[instrument].strings.length;
            document.getElementById('calibrated-count').textContent = `0 / ${totalStrings}`;
            
            initAudio();
        };

        // === Back to Selection ===
        window.backToSelection = function() {
            if (audioContext) {
                stopListening();
                audioContext.close();
                audioContext = null;
            }
            
            // Reset calibration state
            calibratedStrings.clear();
            inTuneStartTime = null;
            lastDetectedString = null;
            resetStabilityTracking();
            stableSampleCount = 0;
            
            document.getElementById('tuner-interface').classList.add('hidden');
            document.getElementById('instrument-selection').classList.remove('hidden');
            currentInstrument = null;
        };

        // === Toggle Tuner ===
        window.toggleTuner = function() {
            const button = document.getElementById('toggle-tuner');
            
            if (isListening) {
                stopListening();
                button.textContent = 'Start Tuner';
                button.className = 'px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl transition-colors';
                document.getElementById('status-text').textContent = 'Tuner stopped';
                resetDeviationIndicator();
                resetStabilityTracking();
                stableSampleCount = 0;
            } else {
                startListening();
                button.textContent = 'Stop Tuner';
                button.className = 'px-8 py-3 bg-sky-600 hover:bg-sky-700 text-white font-semibold rounded-xl transition-colors';
                document.getElementById('status-text').textContent = 'Play a string';
                resetStabilityTracking();
                stableSampleCount = 0;
            }
        };

        // === Cleanup on page unload ===
        window.addEventListener('beforeunload', () => {
            if (audioContext) {
                stopListening();
                audioContext.close();
            }
        });
    </script>
</body>
</html>
